<?xml version="1.0"?>
<!-- ================================================================ -->
<!-- XMLToolGen configuration file for ObCache SQL 1-table-per-class  -->
<!-- storage object header                                            -->
<!--                                                                  -->
<!-- Copyright (c) 2008 xMill Consulting Limited                      -->
<!-- ================================================================ -->

<xt:tool xmlns:xt="obtools.com/ns/tools">

  <!-- Legal info transferred into header - note xmitoolgen will also
  apply its own copyright and license for portions generated solely by it -->
  <xt:legal>
    // XMI Tool configuration for ObCache SQL Schema
    // Copyright (c) 2008 xMill Consulting Limited
    // @@@ MASTER SOURCE - PROPRIETARY AND CONFIDENTIAL - NO LICENCE GRANTED
  </xt:legal>

  <!-- ===== Setup of script processing for rest of file ===== -->
  <xt:script language="C++">
    <!-- Tags to support C++ in XML - $ isn't significant to either -->
    <xt:tags>
      <xt:start-code>$(</xt:start-code>
      <xt:end-code>)$</xt:end-code>
      <xt:start-expr>$=</xt:start-expr>
      <xt:end-expr>=$</xt:end-expr>
    </xt:tags>
  </xt:script>

  <!-- ===== Configuration items for tool ===== -->
  <xt:config file="/etc/obtools/ot-generate-sql-otpc-cpp.cfg.xml" 
             root="sql-otpc-cpp">
    <xt:map name="typemap" path="typemap/type"/>
  </xt:config>

  <!-- =============== Helper code =================  -->
  <xt:code>
    // Helper to manufacture association links for many-1 associations
    string many_to_one_ref(ObTools::UML::AssociationEnd& a)
    {
      if (!a.is_navigable) return "";

      ObTools::UML::AssociationEnd *other = a.get_other_end();
      ObTools::UML::Association *assoc = a.get_association();

      string type = other->participant->name;

      // Get name - best of: role, association name, referent type
      string name = other->name;  
      if (name.empty()) name = assoc->name;  
      if (name.empty()) name = type;
      name = Text::tolower(name);  // Ensure lc variable

      if (other->multiplicity.upper == 1)
        return "a_"+name+" INTEGER, -- Many to 1 "+type;
      else
	return "";
    }

  </xt:code>

  <!-- =============== Main templates =================  -->
     
  <!-- Recursive 'macro' template for packages -->
  <xt:define name="Package" scope="package">

    <!-- Recurse to sub-packages -->
    <xt:use template="Package"/>

    <!-- Class definition -->
    <xt:template name = "C++ class" scope="class" var="myclass">
      // =================================================
      //  Class $=myclass.name=$
      class $= myclass.name =$
      {
        -- Attributes
        <xt:template scope="attribute">
          $= _config.typemap.get(a.type->name, "???") =$ $= a.name =$;
        </xt:template>

        -- Associations
        <xt:template scope="association_end">
        $= many_to_one_ref(a) =$
        </xt:template>
      };
    </xt:template>
  </xt:define>

  <!-- Template for top-level model -->
  <xt:template name="Model" scope="model">
    <!-- All gets bundled into one file -->
    <xt:file>storage.h</xt:file>
   
    // C++ header for $=m.name=$
    // Autogenerated by ObCache storage generator for SQL 1-table-per-class
    // ot-generate-sql-otpc-cpp-header

    <!-- Use recursive package macro on top-level model -->
    <xt:use template="Package"/>
  </xt:template>

<!-- === end ===  -->
</xt:tool>  

